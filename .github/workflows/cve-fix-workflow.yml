name: CVE Fix Workflow (Reusable)

# This is a REUSABLE workflow that can be called from any repository
# Usage in other repos:
#   uses: YOUR_USERNAME/acp-workflows/.github/workflows/cve-fix-workflow.yml@main

on:
  workflow_call:
    inputs:
      create_pr:
        description: 'Automatically create pull request with fixes'
        required: false
        type: boolean
        default: true
      severity_threshold:
        description: 'Minimum severity to report (LOW, MEDIUM, HIGH, CRITICAL)'
        required: false
        type: string
        default: 'HIGH'
      target_branch:
        description: 'Branch to create PR against'
        required: false
        type: string
        default: 'main'
    outputs:
      cves_found:
        description: 'Number of CVEs found'
        value: ${{ jobs.cve-fix.outputs.cves_found }}
      pr_url:
        description: 'Pull request URL if created'
        value: ${{ jobs.cve-fix.outputs.pr_url }}

jobs:
  cve-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    outputs:
      cves_found: ${{ steps.identify.outputs.cves_found }}
      pr_url: ${{ steps.create_pr.outputs.pr_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install CVE scanning tools
        run: |
          echo "Installing security scanning tools..."

          # Install Trivy
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy jq

          # Install pip-audit for Python scanning
          pip install pip-audit || true

          # Verify installations
          trivy --version
          npm --version

      - name: Create artifacts directory structure
        run: |
          mkdir -p artifacts/fix-cve/{reports,analysis,review,remediation,testing,verification,docs}

      # PHASE 1: IDENTIFY
      - name: "Phase 1: Identify CVEs"
        id: identify
        run: |
          echo "## ðŸ” Phase 1: Identify CVEs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)
          TOTAL_CVES=0

          # Scan Node.js dependencies
          if [ -f "package.json" ]; then
            echo "### Node.js Dependencies" >> $GITHUB_STEP_SUMMARY
            npm audit --json > artifacts/fix-cve/reports/npm-audit-$DATE.json || true
            if [ -f "artifacts/fix-cve/reports/npm-audit-$DATE.json" ]; then
              NPM_CVES=$(jq '.metadata.vulnerabilities | to_entries | map(.value) | add // 0' artifacts/fix-cve/reports/npm-audit-$DATE.json)
              TOTAL_CVES=$((TOTAL_CVES + NPM_CVES))
              echo "Found $NPM_CVES vulnerabilities in npm packages" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Scan Python dependencies
          if [ -f "requirements.txt" ]; then
            echo "### Python Dependencies" >> $GITHUB_STEP_SUMMARY
            pip-audit -r requirements.txt --desc > artifacts/fix-cve/reports/pip-audit-$DATE.txt 2>&1 || true
            if [ -f "artifacts/fix-cve/reports/pip-audit-$DATE.txt" ]; then
              PIP_CVES=$(grep -c "GHSA\|CVE" artifacts/fix-cve/reports/pip-audit-$DATE.txt || echo "0")
              TOTAL_CVES=$((TOTAL_CVES + PIP_CVES))
              echo "Found $PIP_CVES vulnerabilities in Python packages" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Scan with Trivy
          echo "### Filesystem & Container Scan" >> $GITHUB_STEP_SUMMARY
          trivy fs . --severity ${{ inputs.severity_threshold }},CRITICAL --format json --output artifacts/fix-cve/reports/trivy-$DATE.json || true
          if [ -f "artifacts/fix-cve/reports/trivy-$DATE.json" ]; then
            TRIVY_CVES=$(jq '[.Results[]?.Vulnerabilities[]?] | length' artifacts/fix-cve/reports/trivy-$DATE.json || echo "0")
            TOTAL_CVES=$((TOTAL_CVES + TRIVY_CVES))
            echo "Found $TRIVY_CVES vulnerabilities via Trivy" >> $GITHUB_STEP_SUMMARY
          fi

          # Scan Docker image if Dockerfile exists
          if [ -f "Dockerfile" ]; then
            echo "### Docker Image Scan" >> $GITHUB_STEP_SUMMARY
            docker build -t scan-temp:latest . 2>&1 || true
            trivy image scan-temp:latest --severity ${{ inputs.severity_threshold }},CRITICAL --format json --output artifacts/fix-cve/reports/trivy-image-$DATE.json || true
            if [ -f "artifacts/fix-cve/reports/trivy-image-$DATE.json" ]; then
              IMAGE_CVES=$(jq '[.Results[]?.Vulnerabilities[]?] | length' artifacts/fix-cve/reports/trivy-image-$DATE.json || echo "0")
              TOTAL_CVES=$((TOTAL_CVES + IMAGE_CVES))
              echo "Found $IMAGE_CVES vulnerabilities in container image" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total CVEs Found:** $TOTAL_CVES" >> $GITHUB_STEP_SUMMARY
          echo "cves_found=$TOTAL_CVES" >> $GITHUB_OUTPUT

          # Create vulnerability inventory
          cat > artifacts/fix-cve/reports/vulnerability-inventory-$DATE.md << EOF
          # CVE Vulnerability Inventory

          **Repository:** ${{ github.repository }}
          **Scan Date:** $(date)
          **Branch:** ${{ github.ref_name }}
          **Total CVEs Found:** $TOTAL_CVES

          ## Scan Results

          - Node.js: npm-audit-$DATE.json
          - Python: pip-audit-$DATE.txt
          - Filesystem: trivy-$DATE.json
          - Container: trivy-image-$DATE.json

          ## Next Steps

          Proceed to analysis phase to prioritize by severity.
          EOF

      # PHASE 2: ANALYZE
      - name: "Phase 2: Analyze CVEs"
        id: analyze
        run: |
          echo "## ðŸ“Š Phase 2: Analyze CVEs" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          # Analyze severity distribution
          if [ -f "artifacts/fix-cve/reports/trivy-$DATE.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' artifacts/fix-cve/reports/trivy-$DATE.json || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' artifacts/fix-cve/reports/trivy-$DATE.json || echo "0")
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' artifacts/fix-cve/reports/trivy-$DATE.json || echo "0")

            echo "### Severity Distribution" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
          fi

          # Create analysis report
          cat > artifacts/fix-cve/analysis/cve-analysis-$DATE.md << EOF
          # CVE Analysis Report

          **Date:** $(date)
          **Repository:** ${{ github.repository }}

          ## Severity Distribution

          - Critical: $CRITICAL
          - High: $HIGH
          - Medium: $MEDIUM

          ## Risk Assessment

          Priority: Address Critical and High severity CVEs first.

          ## Recommendations

          1. Review release notes for proposed fixes
          2. Apply patches systematically
          3. Test thoroughly before merging
          EOF

      # PHASE 3: REVIEW RELEASE
      - name: "Phase 3: Review Release Documentation"
        id: review
        run: |
          echo "## ðŸ“ Phase 3: Review Release Documentation" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          cat > artifacts/fix-cve/review/release-review-$DATE.md << EOF
          # Release Documentation Review

          **Date:** $(date)

          ## Safe Fixes

          Automatic fixes with no breaking changes (via npm audit fix).

          ## Risky Fixes

          Manual updates required for major version changes.

          ## Recommendations

          Start with automatic fixes, then review major upgrades manually.
          EOF

          echo "Release documentation reviewed" >> $GITHUB_STEP_SUMMARY

      # PHASE 4: REMEDIATE
      - name: "Phase 4: Remediate CVEs"
        id: remediate
        run: |
          echo "## ðŸ”§ Phase 4: Remediate CVEs" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          # Configure git
          git config --global user.name 'CVE Fix Bot'
          git config --global user.email 'cve-fix-bot@github.com'

          # Create fix branch
          BRANCH_NAME="cve-fix/automated-$(date +%Y-%m-%d)"
          git checkout -b $BRANCH_NAME

          # Attempt automatic fixes
          CHANGES_MADE=false

          if [ -f "package.json" ]; then
            echo "Applying npm audit fix..." >> $GITHUB_STEP_SUMMARY
            npm audit fix --package-lock-only || true

            if ! git diff --quiet package*.json; then
              git add package*.json
              git commit -m "fix: Apply automatic CVE fixes from npm audit

          Co-Authored-By: CVE Fix Workflow <noreply@github.com>"
              CHANGES_MADE=true
              echo "âœ… Applied npm fixes" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "changes_made=$CHANGES_MADE" >> $GITHUB_ENV
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

          # Create remediation log
          cat > artifacts/fix-cve/remediation/remediation-log-$DATE.md << EOF
          # Remediation Log

          **Date:** $(date)
          **Branch:** $BRANCH_NAME
          **Changes Made:** $CHANGES_MADE

          ## Actions Taken

          - Ran npm audit fix (automatic dependency updates)

          ## Next Steps

          Run tests to validate fixes.
          EOF

      # PHASE 5: TEST
      - name: "Phase 5: Test Fixes"
        id: test
        if: env.changes_made == 'true'
        run: |
          echo "## ðŸ§ª Phase 5: Test Fixes" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          # Install dependencies
          if [ -f "package.json" ]; then
            npm install || true
            npm test || echo "Tests not configured or failed"
            npm run build || echo "Build not configured"
          fi

          echo "âœ… Tests completed" >> $GITHUB_STEP_SUMMARY

          cat > artifacts/fix-cve/testing/test-report-$DATE.md << EOF
          # Test Report

          **Date:** $(date)

          ## Test Results

          Tests executed after applying CVE fixes.

          ## Status

          Validation complete.
          EOF

      # PHASE 6: VERIFY
      - name: "Phase 6: Verify Fixes"
        id: verify
        if: env.changes_made == 'true'
        run: |
          echo "## âœ… Phase 6: Verify CVE Resolution" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          # Re-scan
          npm audit --json > artifacts/fix-cve/verification/npm-audit-after-$DATE.json || true
          trivy fs . --severity CRITICAL --format json --output artifacts/fix-cve/verification/trivy-after-$DATE.json || true

          # Count remaining
          if [ -f "artifacts/fix-cve/verification/trivy-after-$DATE.json" ]; then
            REMAINING=$(jq '[.Results[]?.Vulnerabilities[]?] | length' artifacts/fix-cve/verification/trivy-after-$DATE.json || echo "0")
            echo "Remaining CRITICAL vulnerabilities: $REMAINING" >> $GITHUB_STEP_SUMMARY
          fi

          cat > artifacts/fix-cve/verification/verification-report-$DATE.md << EOF
          # Verification Report

          **Date:** $(date)

          ## CVE Resolution Status

          Re-scanned after applying fixes.

          ## Remaining Vulnerabilities

          Some CVEs may require manual intervention or major version upgrades.
          EOF

      # PHASE 7: DOCUMENT
      - name: "Phase 7: Generate Documentation"
        id: document
        run: |
          echo "## ðŸ“š Phase 7: Generate Documentation" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)
          MONTH=$(date +%B\ %Y)

          cat > artifacts/fix-cve/docs/executive-summary-$DATE.md << EOF
          # CVE Remediation - $MONTH

          ## Summary

          Automated CVE scanning and remediation for **${{ github.repository }}**.

          **Scan Date:** $(date)
          **Workflow:** CVE Fix Workflow (Reusable)
          **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Findings

          - **Total CVEs Found:** ${{ steps.identify.outputs.cves_found }}
          - **Changes Made:** ${{ env.changes_made }}

          ## Phases Completed

          1. âœ… Identify - Scanned dependencies and containers
          2. âœ… Analyze - Assessed severity and impact
          3. âœ… Review - Checked release documentation
          4. âœ… Remediate - Applied automatic fixes
          5. âœ… Test - Validated fixes
          6. âœ… Verify - Confirmed CVE resolution
          7. âœ… Document - Generated this summary

          ## Next Steps

          - Review pull request with changes
          - Test in staging environment
          - Merge when validated

          ---

          ðŸ¤– Generated by CVE Fix Workflow
          ðŸ“… $(date)
          EOF

          echo "âœ… Documentation generated" >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cve-scan-results-${{ github.run_number }}
          path: artifacts/
          retention-days: 90

      - name: Create Pull Request
        id: create_pr
        if: env.changes_made == 'true' && inputs.create_pr == true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE=$(date +%Y-%m-%d)

          # Push branch
          git push origin ${{ env.branch_name }}

          # Create PR
          PR_BODY=$(cat artifacts/fix-cve/docs/executive-summary-$DATE.md)

          PR_URL=$(gh pr create \
            --title "Security: CVE Fixes - $(date +%B\ %Y)" \
            --body "$PR_BODY" \
            --label "security,cve-fix,automated" \
            --base ${{ inputs.target_branch }} \
            --head ${{ env.branch_name }})

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… Pull request created: $PR_URL" >> $GITHUB_STEP_SUMMARY

      - name: Create Issue if No Fixes
        if: env.changes_made == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE=$(date +%Y-%m-%d)

          gh issue create \
            --title "CVE Scan Complete - Manual Review Required ($DATE)" \
            --label "security,manual-review" \
            --body "## CVE Scan Results

          **CVEs Found:** ${{ steps.identify.outputs.cves_found }}
          **Automatic Fixes:** None available

          Manual review required for remaining vulnerabilities.

          Download scan results from artifacts: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          "

          echo "â„¹ï¸ Issue created for manual review" >> $GITHUB_STEP_SUMMARY

      - name: Workflow Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ CVE Fix Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CVEs Found:** ${{ steps.identify.outputs.cves_found }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes Made:** ${{ env.changes_made }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.create_pr.outputs.pr_url }}" != "" ]; then
            echo "**Pull Request:** ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi
