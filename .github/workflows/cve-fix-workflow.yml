name: CVE Fix Workflow (Reusable)

# This is a REUSABLE workflow that can be called from any repository
# Usage in other repos:
#   uses: YOUR_USERNAME/acp-workflows/.github/workflows/cve-fix-workflow.yml@main

on:
  workflow_call:
    inputs:
      create_pr:
        description: 'Automatically create pull request with fixes'
        required: false
        type: boolean
        default: true
      severity_threshold:
        description: 'Minimum severity to report (LOW, MEDIUM, HIGH, CRITICAL)'
        required: false
        type: string
        default: 'HIGH'
      target_branch:
        description: 'Branch to create PR against'
        required: false
        type: string
        default: 'main'
    outputs:
      cves_found:
        description: 'Number of CVEs found'
        value: ${{ jobs.cve-fix.outputs.cves_found }}
      pr_url:
        description: 'Pull request URL if created'
        value: ${{ jobs.cve-fix.outputs.pr_url }}

jobs:
  cve-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    outputs:
      cves_found: ${{ steps.identify.outputs.cves_found }}
      pr_url: ${{ steps.create_pr.outputs.pr_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install CVE scanning tools
        run: |
          echo "Installing security scanning tools..."

          # Install Trivy
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy jq

          # Install pip-audit for Python scanning
          pip install pip-audit || true

          # Verify installations
          trivy --version
          npm --version

      - name: Create artifacts directory structure
        run: |
          mkdir -p artifacts/fix-cve/{reports,analysis,review,remediation,testing,verification,docs}

      # PHASE 1: IDENTIFY
      - name: "Phase 1: Identify CVEs"
        id: identify
        run: |
          echo "## ðŸ” Phase 1: Identify CVEs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)
          TOTAL_CVES=0

          # Scan Node.js dependencies
          if [ -f "package.json" ]; then
            echo "### Node.js Dependencies" >> $GITHUB_STEP_SUMMARY

            # Generate lockfile if missing
            if [ ! -f "package-lock.json" ]; then
              echo "Generating package-lock.json..." >> $GITHUB_STEP_SUMMARY
              npm install --package-lock-only 2>&1 || true
            fi

            # Run npm audit
            npm audit --json > artifacts/fix-cve/reports/npm-audit-$DATE.json 2>&1 || true
            if [ -f "artifacts/fix-cve/reports/npm-audit-$DATE.json" ]; then
              NPM_CVES=$(jq '.metadata.vulnerabilities | to_entries | map(.value) | add // 0' artifacts/fix-cve/reports/npm-audit-$DATE.json || echo "0")
              TOTAL_CVES=$((TOTAL_CVES + NPM_CVES))
              echo "Found $NPM_CVES vulnerabilities in npm packages" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Scan Python dependencies
          if [ -f "requirements.txt" ]; then
            echo "### Python Dependencies" >> $GITHUB_STEP_SUMMARY
            pip-audit -r requirements.txt --desc > artifacts/fix-cve/reports/pip-audit-$DATE.txt 2>&1 || true
            if [ -f "artifacts/fix-cve/reports/pip-audit-$DATE.txt" ]; then
              PIP_CVES=$(grep -c "GHSA\|CVE" artifacts/fix-cve/reports/pip-audit-$DATE.txt || echo "0")
              TOTAL_CVES=$((TOTAL_CVES + PIP_CVES))
              echo "Found $PIP_CVES vulnerabilities in Python packages" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Scan with Trivy
          echo "### Filesystem & Container Scan" >> $GITHUB_STEP_SUMMARY
          trivy fs . --severity ${{ inputs.severity_threshold }},CRITICAL --format json --output artifacts/fix-cve/reports/trivy-$DATE.json || true
          if [ -f "artifacts/fix-cve/reports/trivy-$DATE.json" ]; then
            TRIVY_CVES=$(jq '[.Results[]?.Vulnerabilities[]?] | length' artifacts/fix-cve/reports/trivy-$DATE.json || echo "0")
            TOTAL_CVES=$((TOTAL_CVES + TRIVY_CVES))
            echo "Found $TRIVY_CVES vulnerabilities via Trivy" >> $GITHUB_STEP_SUMMARY
          fi

          # Scan Docker image if Dockerfile exists
          if [ -f "Dockerfile" ]; then
            echo "### Docker Image Scan" >> $GITHUB_STEP_SUMMARY
            docker build -t scan-temp:latest . 2>&1 || true
            trivy image scan-temp:latest --severity ${{ inputs.severity_threshold }},CRITICAL --format json --output artifacts/fix-cve/reports/trivy-image-$DATE.json || true
            if [ -f "artifacts/fix-cve/reports/trivy-image-$DATE.json" ]; then
              IMAGE_CVES=$(jq '[.Results[]?.Vulnerabilities[]?] | length' artifacts/fix-cve/reports/trivy-image-$DATE.json || echo "0")
              TOTAL_CVES=$((TOTAL_CVES + IMAGE_CVES))
              echo "Found $IMAGE_CVES vulnerabilities in container image" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total CVEs Found:** $TOTAL_CVES" >> $GITHUB_STEP_SUMMARY
          echo "cves_found=$TOTAL_CVES" >> $GITHUB_OUTPUT

          # Create vulnerability inventory
          cat > artifacts/fix-cve/reports/vulnerability-inventory-$DATE.md << EOF
          # CVE Vulnerability Inventory

          **Repository:** ${{ github.repository }}
          **Scan Date:** $(date)
          **Branch:** ${{ github.ref_name }}
          **Total CVEs Found:** $TOTAL_CVES

          ## Scan Results

          - Node.js: npm-audit-$DATE.json
          - Python: pip-audit-$DATE.txt
          - Filesystem: trivy-$DATE.json
          - Container: trivy-image-$DATE.json

          ## Next Steps

          Proceed to analysis phase to prioritize by severity.
          EOF

      # PHASE 2: ANALYZE
      - name: "Phase 2: Analyze CVEs"
        id: analyze
        run: |
          echo "## ðŸ“Š Phase 2: Analyze CVEs" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          # Analyze severity distribution
          if [ -f "artifacts/fix-cve/reports/trivy-$DATE.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' artifacts/fix-cve/reports/trivy-$DATE.json || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' artifacts/fix-cve/reports/trivy-$DATE.json || echo "0")
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' artifacts/fix-cve/reports/trivy-$DATE.json || echo "0")

            echo "### Severity Distribution" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
          fi

          # Create analysis report
          cat > artifacts/fix-cve/analysis/cve-analysis-$DATE.md << EOF
          # CVE Analysis Report

          **Date:** $(date)
          **Repository:** ${{ github.repository }}

          ## Severity Distribution

          - Critical: $CRITICAL
          - High: $HIGH
          - Medium: $MEDIUM

          ## Risk Assessment

          Priority: Address Critical and High severity CVEs first.

          ## Recommendations

          1. Review release notes for proposed fixes
          2. Apply patches systematically
          3. Test thoroughly before merging
          EOF

      # PHASE 3: REVIEW RELEASE
      - name: "Phase 3: Review Release Documentation"
        id: review
        run: |
          echo "## ðŸ“ Phase 3: Review Release Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)
          SAFE_FIXES=0
          RISKY_FIXES=0
          MISSING_DOCS=0

          # Initialize review report
          cat > artifacts/fix-cve/review/release-review-$DATE.md << 'REVIEW_START'
          # Release Documentation Review

          **Date:** $(date)
          **Repository:** ${{ github.repository }}

          This report reviews release documentation for all proposed CVE fixes to identify:
          - Breaking changes
          - New dependencies
          - Documentation quality
          - Safe vs risky updates

          ---

          REVIEW_START

          # Review npm packages if package.json exists
          if [ -f "package.json" ] && [ -f "artifacts/fix-cve/reports/npm-audit-$DATE.json" ]; then
            echo "### ðŸ“¦ Node.js Package Review" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract vulnerable packages and their fix versions
            VULNERABLE_PACKAGES=$(jq -r '.vulnerabilities | to_entries[] | select(.value.fixAvailable) | "\(.key)|\(.value.via[0].title // "Unknown")|\(.value.fixAvailable.version // .value.fixAvailable.name)"' artifacts/fix-cve/reports/npm-audit-$DATE.json 2>/dev/null || echo "")

            cat >> artifacts/fix-cve/review/release-review-$DATE.md << 'NPM_SECTION'
          ## Node.js Packages

          ### Packages Reviewed

          NPM_SECTION

            if [ -n "$VULNERABLE_PACKAGES" ]; then
              echo "$VULNERABLE_PACKAGES" | while IFS='|' read -r PACKAGE VULN_TYPE FIX_VERSION; do
                if [ -n "$PACKAGE" ]; then
                  # Get current version from package.json
                  CURRENT_VERSION=$(jq -r ".dependencies.\"$PACKAGE\" // .devDependencies.\"$PACKAGE\" // \"unknown\"" package.json 2>/dev/null)

                  echo "#### \`$PACKAGE\`" >> artifacts/fix-cve/review/release-review-$DATE.md
                  echo "" >> artifacts/fix-cve/review/release-review-$DATE.md
                  echo "- **Current Version:** $CURRENT_VERSION" >> artifacts/fix-cve/review/release-review-$DATE.md
                  echo "- **Fix Version:** $FIX_VERSION" >> artifacts/fix-cve/review/release-review-$DATE.md
                  echo "- **Vulnerability:** $VULN_TYPE" >> artifacts/fix-cve/review/release-review-$DATE.md

                  # Determine if it's a major version change (risky)
                  if [[ "$FIX_VERSION" =~ ^[0-9]+ ]] && [[ "$CURRENT_VERSION" =~ ^[0-9]+ ]]; then
                    FIX_MAJOR=$(echo "$FIX_VERSION" | cut -d. -f1 | tr -d '^~>=<')
                    CURRENT_MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1 | tr -d '^~>=<')

                    if [ "$FIX_MAJOR" != "$CURRENT_MAJOR" ]; then
                      echo "- **âš ï¸  Risk Level:** HIGH (Major version change)" >> artifacts/fix-cve/review/release-review-$DATE.md
                      echo "- **Breaking Changes:** Likely - review changelog carefully" >> artifacts/fix-cve/review/release-review-$DATE.md
                      echo "- **Documentation:** Check https://github.com/$PACKAGE/blob/main/CHANGELOG.md" >> artifacts/fix-cve/review/release-review-$DATE.md
                      RISKY_FIXES=$((RISKY_FIXES + 1))
                      echo "  - âš ï¸  **$PACKAGE**: $CURRENT_VERSION â†’ $FIX_VERSION (Major change)" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "- **âœ… Risk Level:** LOW (Patch/minor update)" >> artifacts/fix-cve/review/release-review-$DATE.md
                      echo "- **Breaking Changes:** Unlikely" >> artifacts/fix-cve/review/release-review-$DATE.md
                      echo "- **Safe to Apply:** Yes" >> artifacts/fix-cve/review/release-review-$DATE.md
                      SAFE_FIXES=$((SAFE_FIXES + 1))
                      echo "  - âœ… **$PACKAGE**: $CURRENT_VERSION â†’ $FIX_VERSION (Safe)" >> $GITHUB_STEP_SUMMARY
                    fi
                  else
                    echo "- **Risk Level:** Unknown (could not parse versions)" >> artifacts/fix-cve/review/release-review-$DATE.md
                    MISSING_DOCS=$((MISSING_DOCS + 1))
                  fi

                  echo "" >> artifacts/fix-cve/review/release-review-$DATE.md
                  echo "---" >> artifacts/fix-cve/review/release-review-$DATE.md
                  echo "" >> artifacts/fix-cve/review/release-review-$DATE.md
                fi
              done
            else
              echo "No fixable vulnerabilities found in npm audit output." >> artifacts/fix-cve/review/release-review-$DATE.md
              echo "  â„¹ï¸  No npm fixes available" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Create safe fixes summary
          cat > artifacts/fix-cve/review/safe-fixes-$DATE.md << EOF
          # Safe Fixes - Ready to Apply

          **Date:** $(date)
          **Total Safe Fixes:** $SAFE_FIXES

          ## Criteria for Safe Fixes

          - âœ… Patch or minor version updates only
          - âœ… No breaking changes expected
          - âœ… Well-documented releases
          - âœ… Backward compatible

          ## Recommendation

          These fixes can be applied automatically via \`npm audit fix\` with low risk of breaking changes.

          EOF

          # Create risky fixes summary
          cat > artifacts/fix-cve/review/risky-fixes-$DATE.md << EOF
          # Risky Fixes - Manual Review Required

          **Date:** $(date)
          **Total Risky Fixes:** $RISKY_FIXES
          **Missing Documentation:** $MISSING_DOCS

          ## Why These Are Risky

          - âš ï¸  Major version changes (potential breaking changes)
          - âš ï¸  Insufficient release documentation
          - âš ï¸  May require code changes to integrate

          ## Recommendation

          1. Review changelog and migration guides carefully
          2. Test in development environment first
          3. Check for deprecated APIs or removed features
          4. Consider creating a separate PR for each major update

          ## Breaking Change Indicators to Watch For

          - API changes or removals
          - New required dependencies
          - Changed configuration formats
          - Deprecated features removed
          - Minimum version requirements changed (Node.js, etc.)

          EOF

          # Add summary to main review
          cat >> artifacts/fix-cve/review/release-review-$DATE.md << EOF

          ## ðŸ“Š Review Summary

          | Category | Count | Status |
          |----------|-------|--------|
          | âœ… Safe Fixes (Patch/Minor) | $SAFE_FIXES | Ready to apply |
          | âš ï¸  Risky Fixes (Major versions) | $RISKY_FIXES | Manual review needed |
          | â“ Missing Documentation | $MISSING_DOCS | Research required |

          ## ðŸŽ¯ Recommendations

          ### Immediate Actions
          1. **Apply safe fixes** automatically via \`npm audit fix\`
          2. **Review risky fixes** manually before applying
          3. **Research missing docs** for packages without clear upgrade paths

          ### Before Applying Risky Fixes
          - [ ] Read full CHANGELOG for major version updates
          - [ ] Check for breaking changes in release notes
          - [ ] Review migration guides (if available)
          - [ ] Test in isolated environment first
          - [ ] Update code if APIs changed

          ## ðŸ“š Documentation Sources Checked

          - npm audit output (package metadata)
          - Package version analysis (semver)
          - GitHub repository links (where available)

          ## âš ï¸  Alarming Findings

          EOF

          # Check for alarming patterns
          ALARMING=0

          if [ $RISKY_FIXES -gt 5 ]; then
            echo "- ðŸš¨ **High number of major version changes ($RISKY_FIXES)** - Consider staged rollout" >> artifacts/fix-cve/review/release-review-$DATE.md
            ALARMING=$((ALARMING + 1))
          fi

          if [ $MISSING_DOCS -gt 3 ]; then
            echo "- ðŸš¨ **Multiple packages with missing documentation ($MISSING_DOCS)** - Extra caution needed" >> artifacts/fix-cve/review/release-review-$DATE.md
            ALARMING=$((ALARMING + 1))
          fi

          if [ $ALARMING -eq 0 ]; then
            echo "- âœ… No critical concerns identified" >> artifacts/fix-cve/review/release-review-$DATE.md
          fi

          cat >> artifacts/fix-cve/review/release-review-$DATE.md << 'EOF'

          ## ðŸ“– Next Steps

          1. Review the **Safe Fixes** list and apply automatically
          2. For **Risky Fixes**, create separate testing branches
          3. For **Missing Documentation**, research each package individually

          ---

          **Generated by:** CVE Fix Workflow
          **Review Confidence:** Medium (automated analysis)
          **Manual Review:** Recommended for risky fixes
          EOF

          # Add summary to GitHub Actions output
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Safe Fixes | $SAFE_FIXES |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸  Risky Fixes | $RISKY_FIXES |" >> $GITHUB_STEP_SUMMARY
          echo "| â“ Missing Docs | $MISSING_DOCS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $ALARMING -gt 0 ]; then
            echo "### ðŸš¨ Alarming Findings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ $RISKY_FIXES -gt 5 ]; then
              echo "- **High number of major version changes:** $RISKY_FIXES packages require major updates" >> $GITHUB_STEP_SUMMARY
            fi
            if [ $MISSING_DOCS -gt 3 ]; then
              echo "- **Insufficient documentation:** $MISSING_DOCS packages lack clear upgrade information" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ðŸ’¡ Recommendation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $SAFE_FIXES -gt 0 ]; then
            echo "âœ… Proceed with automatic fixes for $SAFE_FIXES safe updates" >> $GITHUB_STEP_SUMMARY
          fi
          if [ $RISKY_FIXES -gt 0 ]; then
            echo "âš ï¸  Manual review required for $RISKY_FIXES risky updates" >> $GITHUB_STEP_SUMMARY
          fi

          # Export counts for later use
          echo "safe_fixes=$SAFE_FIXES" >> $GITHUB_ENV
          echo "risky_fixes=$RISKY_FIXES" >> $GITHUB_ENV
          echo "missing_docs=$MISSING_DOCS" >> $GITHUB_ENV

      # PHASE 4: REMEDIATE
      - name: "Phase 4: Remediate CVEs"
        id: remediate
        run: |
          echo "## ðŸ”§ Phase 4: Remediate CVEs" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          # Configure git
          git config --global user.name 'CVE Fix Bot'
          git config --global user.email 'cve-fix-bot@github.com'

          # Create fix branch
          BRANCH_NAME="cve-fix/automated-$(date +%Y-%m-%d)"
          git checkout -b $BRANCH_NAME

          # Attempt automatic fixes
          CHANGES_MADE=false

          if [ -f "package.json" ]; then
            echo "Applying npm audit fix..." >> $GITHUB_STEP_SUMMARY
            npm audit fix --package-lock-only || true

            if ! git diff --quiet package*.json; then
              git add package*.json
              git commit -m "fix: Apply automatic CVE fixes from npm audit

          Co-Authored-By: CVE Fix Workflow <noreply@github.com>"
              CHANGES_MADE=true
              echo "âœ… Applied npm fixes" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "changes_made=$CHANGES_MADE" >> $GITHUB_ENV
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

          # Create remediation log
          cat > artifacts/fix-cve/remediation/remediation-log-$DATE.md << EOF
          # Remediation Log

          **Date:** $(date)
          **Branch:** $BRANCH_NAME
          **Changes Made:** $CHANGES_MADE

          ## Actions Taken

          - Ran npm audit fix (automatic dependency updates)

          ## Next Steps

          Run tests to validate fixes.
          EOF

      # PHASE 5: TEST
      - name: "Phase 5: Test Fixes"
        id: test
        if: env.changes_made == 'true'
        run: |
          echo "## ðŸ§ª Phase 5: Test Fixes" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          # Install dependencies
          if [ -f "package.json" ]; then
            npm install || true
            npm test || echo "Tests not configured or failed"
            npm run build || echo "Build not configured"
          fi

          echo "âœ… Tests completed" >> $GITHUB_STEP_SUMMARY

          cat > artifacts/fix-cve/testing/test-report-$DATE.md << EOF
          # Test Report

          **Date:** $(date)

          ## Test Results

          Tests executed after applying CVE fixes.

          ## Status

          Validation complete.
          EOF

      # PHASE 6: VERIFY
      - name: "Phase 6: Verify Fixes"
        id: verify
        if: env.changes_made == 'true'
        run: |
          echo "## âœ… Phase 6: Verify CVE Resolution" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)

          # Re-scan
          npm audit --json > artifacts/fix-cve/verification/npm-audit-after-$DATE.json || true
          trivy fs . --severity CRITICAL --format json --output artifacts/fix-cve/verification/trivy-after-$DATE.json || true

          # Count remaining
          if [ -f "artifacts/fix-cve/verification/trivy-after-$DATE.json" ]; then
            REMAINING=$(jq '[.Results[]?.Vulnerabilities[]?] | length' artifacts/fix-cve/verification/trivy-after-$DATE.json || echo "0")
            echo "Remaining CRITICAL vulnerabilities: $REMAINING" >> $GITHUB_STEP_SUMMARY
          fi

          cat > artifacts/fix-cve/verification/verification-report-$DATE.md << EOF
          # Verification Report

          **Date:** $(date)

          ## CVE Resolution Status

          Re-scanned after applying fixes.

          ## Remaining Vulnerabilities

          Some CVEs may require manual intervention or major version upgrades.
          EOF

      # PHASE 7: DOCUMENT
      - name: "Phase 7: Generate Documentation"
        id: document
        run: |
          echo "## ðŸ“š Phase 7: Generate Documentation" >> $GITHUB_STEP_SUMMARY

          DATE=$(date +%Y-%m-%d)
          MONTH=$(date +%B\ %Y)

          cat > artifacts/fix-cve/docs/executive-summary-$DATE.md << EOF
          # CVE Remediation - $MONTH

          ## Summary

          Automated CVE scanning and remediation for **${{ github.repository }}**.

          **Scan Date:** $(date)
          **Workflow:** CVE Fix Workflow (Reusable)
          **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Findings

          - **Total CVEs Found:** ${{ steps.identify.outputs.cves_found }}
          - **Changes Made:** ${{ env.changes_made }}

          ## Release Review Summary

          - **Safe Fixes (Patch/Minor Updates):** ${safe_fixes:-0}
          - **Risky Fixes (Major Version Changes):** ${risky_fixes:-0}
          - **Packages with Missing Documentation:** ${missing_docs:-0}

          ### Alarming Findings

          ${alarming_findings:-No alarming patterns detected during release review.}

          ### Fix Classification

          **Safe Fixes** are patch or minor version updates that are unlikely to introduce breaking changes. These are recommended for immediate application.

          **Risky Fixes** involve major version changes that may include breaking changes, architectural updates, or significant API modifications. These require careful testing and review before deployment.

          ## Phases Completed

          1. âœ… Identify - Scanned dependencies and containers
          2. âœ… Analyze - Assessed severity and impact
          3. âœ… Review - Checked release documentation
          4. âœ… Remediate - Applied automatic fixes
          5. âœ… Test - Validated fixes
          6. âœ… Verify - Confirmed CVE resolution
          7. âœ… Document - Generated this summary

          ## Next Steps

          EOF

          # Add conditional recommendations based on review findings
          if [ "${risky_fixes:-0}" -gt 0 ]; then
            cat >> artifacts/fix-cve/docs/executive-summary-$DATE.md << EOF
          ### âš ï¸ Risky Fixes Detected

          This scan identified **${risky_fixes}** major version updates that may contain breaking changes:

          1. **Review the risky-fixes report** at \`artifacts/fix-cve/review/risky-fixes-$DATE.md\`
          2. **Check vendor migration guides** for each major version update
          3. **Test thoroughly in staging** before production deployment
          4. **Consider staged rollout** for high-risk packages
          5. **Review the pull request carefully** - breaking changes may require code modifications

          EOF
          fi

          if [ "${safe_fixes:-0}" -gt 0 ]; then
            cat >> artifacts/fix-cve/docs/executive-summary-$DATE.md << EOF
          ### âœ… Safe Fixes Available

          This scan identified **${safe_fixes}** safe updates (patch/minor versions):

          1. **Review the safe-fixes report** at \`artifacts/fix-cve/review/safe-fixes-$DATE.md\`
          2. **These are recommended for immediate application**
          3. **Automated tests should cover most scenarios**
          4. **Standard review and merge process applies**

          EOF
          fi

          cat >> artifacts/fix-cve/docs/executive-summary-$DATE.md << EOF

          ### General Recommendations

          - Review the pull request with changes
          - Run full test suite in staging environment
          - Check the detailed review reports in \`artifacts/fix-cve/review/\`
          - Verify no breaking changes impact your codebase
          - Merge when validated and approved

          ---

          ðŸ¤– Generated by CVE Fix Workflow
          ðŸ“… $(date)
          EOF

          echo "âœ… Documentation generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Release Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Safe Fixes (Patch/Minor) | ${safe_fixes:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ Risky Fixes (Major) | ${risky_fixes:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Missing Documentation | ${missing_docs:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$alarming_findings" ]; then
            echo "### âš ï¸ Alarming Findings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$alarming_findings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ“„ **Full Reports Available:**" >> $GITHUB_STEP_SUMMARY
          echo "- Release Review: \`artifacts/fix-cve/review/release-review-$DATE.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- Safe Fixes: \`artifacts/fix-cve/review/safe-fixes-$DATE.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- Risky Fixes: \`artifacts/fix-cve/review/risky-fixes-$DATE.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- Executive Summary: \`artifacts/fix-cve/docs/executive-summary-$DATE.md\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cve-scan-results-${{ github.run_number }}
          path: artifacts/
          retention-days: 90

      - name: Create Pull Request
        id: create_pr
        if: env.changes_made == 'true' && inputs.create_pr == true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE=$(date +%Y-%m-%d)

          # Push branch
          git push origin ${{ env.branch_name }}

          # Create PR
          PR_BODY=$(cat artifacts/fix-cve/docs/executive-summary-$DATE.md)

          PR_URL=$(gh pr create \
            --title "Security: CVE Fixes - $(date +%B\ %Y)" \
            --body "$PR_BODY" \
            --label "security,cve-fix,automated" \
            --base ${{ inputs.target_branch }} \
            --head ${{ env.branch_name }})

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… Pull request created: $PR_URL" >> $GITHUB_STEP_SUMMARY

      - name: Workflow Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ CVE Fix Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CVEs Found:** ${{ steps.identify.outputs.cves_found }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes Made:** ${{ env.changes_made }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.create_pr.outputs.pr_url }}" != "" ]; then
            echo "**Pull Request:** ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi
