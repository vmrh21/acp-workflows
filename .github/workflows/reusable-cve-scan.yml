name: Reusable CVE Scan Workflow

on:
  workflow_call:
    inputs:
      repository:
        description: 'Repository to scan (owner/repo)'
        required: true
        type: string
      create_pr:
        description: 'Create pull request with fixes'
        required: false
        type: boolean
        default: true
    secrets:
      GH_TOKEN:
        required: true

jobs:
  cve-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          token: ${{ secrets.GH_TOKEN }}

      - name: Checkout CVE workflow
        uses: actions/checkout@v4
        with:
          repository: YOUR_USERNAME/acp-workflows
          path: .cve-workflow

      - name: Setup tools
        run: |
          # Install Trivy
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Run CVE Workflow Phases
        run: |
          # Use the workflow scripts from .cve-workflow
          bash .cve-workflow/scripts/run-identify.sh
          bash .cve-workflow/scripts/run-analyze.sh
          # etc...
