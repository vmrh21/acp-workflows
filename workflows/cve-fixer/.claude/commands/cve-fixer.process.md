# /cve-fixer.process - Analyze and Fix CVEs from JIRA Component

## Purpose
Fetches unresolved CVE issues from a JIRA component, analyzes and categorizes them by severity and fix availability, asks the user which CVEs to fix, then automatically applies fixes and creates pull requests.

## Prerequisites
- JIRA MCP server configured with credentials (JIRA_URL, JIRA_EMAIL, JIRA_API_TOKEN)
- Git configured with access to target repositories
- User must provide JIRA component name and repository information

## Process

### Phase 1: Gather Information

1. **Ask for JIRA Component**
   - Prompt: "Which JIRA component contains the CVE issues you want to analyze?"
   - Validate the component exists in JIRA
   - Confirm the project key if needed

2. **Ask for Repository Information**
   - Prompt: "Which repository/repositories should I apply fixes to?"
   - Accept formats:
     - GitHub URL: `https://github.com/owner/repo`
     - SSH URL: `git@github.com:owner/repo.git`
     - Local path: `/path/to/repo`
     - Multiple repos: comma-separated list
   - Validate repository access before proceeding

### Phase 2: Fetch Unresolved CVEs

3. **Query JIRA for Unresolved CVEs Only**
   - Use JQL: `component = "COMPONENT_NAME" AND summary ~ "CVE" AND status NOT IN (Closed, Done, Resolved)`
   - This excludes:
     - Closed issues
     - Done issues
     - Resolved issues
   - Only fetches open/unresolved CVE issues
   - Show progress: "üîç Fetching unresolved CVEs from component '{component}'..."
   - Display count: "Found X unresolved CVE issues"

### Phase 3: Analyze and Categorize

4. **Extract CVE Information from Each Issue**
   - For each issue:
     - Extract CVE ID from summary/description
     - Extract severity (Critical, High, Medium, Low) from:
       - Priority field
       - Labels
       - Description text
       - Custom fields
     - Read description and comments to check if fix is mentioned
     - Look for:
       - Version numbers to upgrade to
       - Patch information
       - Workaround instructions
       - Package names and versions

5. **Categorize CVEs**
   - **By Severity:**
     - Critical: Count
     - High: Count
     - Medium: Count
     - Low: Count
   - **By Fix Availability:**
     - CVEs with fixes mentioned in JIRA: Count (list CVE IDs)
     - CVEs without current fixes: Count (list CVE IDs)

### Phase 4: Present Summary

6. **Display Short Summary**
   - Show concise breakdown:
   ```
   üìä CVE Analysis for Component: {component}

   Total Unresolved CVEs: X

   By Severity:
   ‚Ä¢ Critical: X CVEs
   ‚Ä¢ High: X CVEs
   ‚Ä¢ Medium: X CVEs
   ‚Ä¢ Low: X CVEs

   Fix Availability:
   ‚Ä¢ CVEs with fixes mentioned: X
     - {CVE-2024-1234} (Critical) - Upgrade to version X.Y.Z
     - {CVE-2024-5678} (High) - Apply patch from description

   ‚Ä¢ CVEs without current fixes: X
     - {CVE-2024-9999} (Medium) - No fix information in JIRA
   ```

### Phase 5: Ask User for Action

7. **Present Fix Options**
   - Ask: "Which CVEs would you like me to fix?"
   - Provide options:
     1. **Fix a specific CVE** - Enter CVE ID (e.g., CVE-2024-1234)
     2. **Fix all CVEs with fixes mentioned** - Automatically fix all X CVEs that have fix information
     3. **Skip** - Exit without making changes
   - Wait for user response

### Phase 6: Apply Fixes

8. **For Each CVE to Fix**

   **Step A: Prepare Fix Information**
   - Extract fix details from JIRA description:
     - Package/dependency name
     - Current vulnerable version
     - Recommended fix version from JIRA
   - Check for newer fix:
     - Query npm/pip/maven/etc. for latest version
     - Compare with JIRA recommendation
     - If newer version available, note it for PR description
   - Show: "üîß Preparing fix for {CVE-ID}..."

   **Step B: Clone and Setup Repository**
   - Clone repository if not already local
   - Checkout main/master branch
   - Pull latest changes
   - Create feature branch: `fix/cve-{cve-id-lowercase}`
   - Show: "üì¶ Setting up repository..."

   **Step C: Apply the Fix**
   - Identify files to modify:
     - `package.json` for npm
     - `requirements.txt` or `pyproject.toml` for Python
     - `pom.xml` for Maven
     - `go.mod` for Go
   - Apply version update:
     - Update dependency version
     - Run dependency update command if needed (npm install, pip install, etc.)
   - Show: "‚úèÔ∏è Applying fix to {files}..."

   **Step D: Run Tests (if available)**
   - Detect test command:
     - Check `package.json` scripts
     - Check `Makefile`
     - Common patterns: `npm test`, `pytest`, `mvn test`
   - If tests exist, run them
   - If tests fail:
     - Show error output
     - Ask user if they want to:
       - Continue with PR anyway
       - Skip this CVE
       - Abort all fixes
   - Show: "üß™ Running tests..."

   **Step E: Commit Changes**
   - Stage modified files
   - Create commit with message:
     ```
     Fix {CVE-ID}: {Brief vulnerability description}

     - Updated {package-name} from {old-version} to {new-version}
     - Addresses {vulnerability-type} vulnerability
     - Severity: {Critical/High/Medium/Low}

     Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
     ```
   - Show: "üíæ Committing changes..."

   **Step F: Push and Create PR**
   - Push branch to remote
   - Create pull request using `gh pr create` with:
     - **Title:** `Fix {CVE-ID}: {Brief description}`
     - **Body:**
       ```markdown
       ## Security Fix: {CVE-ID}

       **Severity:** {Critical/High/Medium/Low}

       ### Vulnerability Description
       {Brief explanation of what the CVE is and why it's dangerous}

       ### Fix Applied
       - Updated `{package-name}` from version `{old-version}` to `{new-version}`
       - {Additional fix details}

       {If using newer version than JIRA mentioned:}
       ‚ÑπÔ∏è **Note:** A newer fix version ({new-version}) was available and applied instead of the originally recommended version ({jira-version}).

       ### Files Modified
       - `{file1}`
       - `{file2}`

       ### Testing
       {If tests ran: ‚úÖ All tests passed}
       {If no tests: ‚ö†Ô∏è No automated tests detected - manual verification recommended}

       ### References
       - CVE Details: https://nvd.nist.gov/vuln/detail/{CVE-ID}
       - Package Security Advisory: {link if available}

       ---
       ü§ñ Generated with Claude Code CVE Fixer
       ```
   - **IMPORTANT:** Do NOT include JIRA issue links or references in PR
   - Show: "üì§ Creating pull request..."
   - Display PR URL when created

9. **Track Progress Across Multiple CVEs**
   - If fixing multiple CVEs, show overall progress:
   ```
   Fixing CVEs: [2/5]
   ‚úÖ CVE-2024-1234 - PR created: https://github.com/...
   ‚úÖ CVE-2024-5678 - PR created: https://github.com/...
   üîß CVE-2024-9999 - In progress...
   ‚è≥ CVE-2024-1111 - Pending...
   ‚è≥ CVE-2024-2222 - Pending...
   ```

### Phase 7: Generate Summary Report

10. **Create Fix Summary Report**
    - Save to: `artifacts/cve-fixer/fixes/fix-summary-{component}-{timestamp}.md`
    - Include:
      - Component processed
      - Date and time
      - Total CVEs analyzed
      - Breakdown by severity
      - **CVEs Fixed:**
        - CVE ID
        - Severity
        - PR URL
        - Files modified
        - Version changes
      - **CVEs Skipped:**
        - CVE ID
        - Reason (no fix available, user choice, etc.)
      - **Next Steps:**
        - Review PRs
        - Merge after approval
        - Monitor for deployment
    - Show: "üìÑ Summary report saved to artifacts/cve-fixer/fixes/"

## Output

### Real-Time Progress Display
```
üîç Fetching unresolved CVEs from component "security"...
Found 8 unresolved CVE issues

üìä Analyzing CVEs...

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä CVE Analysis for Component: security

Total Unresolved CVEs: 8

By Severity:
‚Ä¢ Critical: 2 CVEs
‚Ä¢ High: 3 CVEs
‚Ä¢ Medium: 2 CVEs
‚Ä¢ Low: 1 CVE

Fix Availability:
‚Ä¢ CVEs with fixes mentioned: 5
  - CVE-2025-66031 (Critical) - Upgrade node-forge to 1.3.2
  - CVE-2024-1234 (High) - Upgrade lodash to 4.17.21
  - CVE-2024-5678 (High) - Upgrade axios to 0.21.2
  - CVE-2024-9999 (Medium) - Apply patch from advisory
  - CVE-2024-1111 (Low) - Update minimist to 1.2.6

‚Ä¢ CVEs without current fixes: 3
  - CVE-2024-7777 (Critical) - No fix information in JIRA
  - CVE-2024-8888 (Medium) - Under investigation
  - CVE-2024-9999 (Low) - Workaround only
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Which CVEs would you like me to fix?
1. Fix a specific CVE
2. Fix all CVEs with fixes mentioned (5 CVEs)
3. Skip

{User chooses option 2}

üöÄ Fixing 5 CVEs...

[1/5] Fixing CVE-2025-66031...
  üîß Preparing fix information...
  ‚ÑπÔ∏è Newer version available: 1.3.3 (JIRA recommended 1.3.2)
  üì¶ Cloning repository...
  ‚úèÔ∏è Updating package.json...
  üß™ Running tests... ‚úÖ Passed
  üíæ Committing changes...
  üì§ Creating pull request...
  ‚úÖ PR created: https://github.com/user/repo/pull/123

[2/5] Fixing CVE-2024-1234...
  ...

‚úÖ All fixes complete!
üìÑ Summary report: artifacts/cve-fixer/fixes/fix-summary-security-20260130.md
```

### Generated Files

- **Fix Summary Report**: `artifacts/cve-fixer/fixes/fix-summary-{component}-{timestamp}.md`
  - Complete record of all CVEs analyzed
  - Which CVEs were fixed with PR links
  - Which CVEs were skipped and why
  - Next steps for review and deployment

- **Analysis Report**: `artifacts/cve-fixer/reports/cve-analysis-{component}-{timestamp}.md`
  - Initial analysis breakdown
  - Severity categorization
  - Fix availability summary

## Usage Examples

Basic usage:
```
/cve-fixer.process
```

The command will prompt for:
1. JIRA component name
2. Repository/repositories for fixes

## Success Criteria

After running this command, you should have:
- [ ] Analyzed all unresolved CVEs from the component
- [ ] Received concise summary with severity and fix breakdown
- [ ] Selected which CVEs to fix (specific or all fixable)
- [ ] Pull requests created for selected CVEs with:
  - [ ] Fixes applied
  - [ ] Tests run (if available)
  - [ ] Detailed PR descriptions
  - [ ] NO JIRA references in PRs
- [ ] Summary report generated in artifacts/cve-fixer/fixes/
- [ ] **IMPORTANT: No changes made to JIRA issues**

## Next Steps

After completing this workflow:
1. Review the generated pull requests
2. Check PR descriptions for accuracy
3. Verify fixes are correct
4. Request code review from team members
5. Merge PRs after approval
6. Monitor deployment and verify CVEs are resolved
7. **Manually update JIRA issues** with PR links if desired (workflow doesn't do this)

## Notes

**JIRA READ-ONLY POLICY:**
- ‚úÖ ALLOWED: Fetching issues, reading descriptions, reading comments
- ‚ùå FORBIDDEN: Adding comments, updating fields, changing status, creating issues
- All JIRA access is READ-ONLY - no modifications will be made to JIRA
- Users must manually update JIRA issues with PR links if desired

**PULL REQUEST POLICY:**
- ‚úÖ Pull requests ARE created automatically
- ‚úÖ PR descriptions include CVE details and fix information
- ‚ùå PR descriptions will NOT include JIRA issue links or references
- ‚ÑπÔ∏è If newer fix version available, PR description mentions it

**FIX DETECTION:**
- Workflow looks in JIRA description and comments for:
  - Version numbers (e.g., "upgrade to 1.3.2")
  - Package names
  - Patch information
  - Workaround instructions
- If fix information is found, CVE is categorized as "fixable"
- If no fix information, CVE is categorized as "no current fix"

**VERSION CHECKING:**
- For each fix, workflow checks package registry for latest version
- If newer version available than JIRA mentions, uses newer version
- Notes the version difference in PR description

**REPOSITORY HANDLING:**
- If multiple repositories provided, asks which repo each CVE applies to
- If CVE affects multiple repos, can create PRs in each repo
- Repositories are cloned to temporary locations for fixing

**ERROR HANDLING:**
- **Component not found**: Suggests similar component names
- **No unresolved CVEs**: Confirms and exits gracefully
- **JIRA authentication failure**: Prompts to check environment variables
- **Repository access failure**: Shows error and asks for correct URL/path
- **Test failures**: Asks user whether to continue with PR or skip
- **PR creation failure**: Logs error, saves local changes, continues to next CVE

## Testing

To test this workflow with CVE-2025-66031:
1. Create JIRA issue with:
   - Component: (your test component)
   - Summary: "CVE-2025-66031: node-forge vulnerable to unbounded recursion"
   - Description: "Upgrade node-forge to version 1.3.2 or higher"
   - Priority: Critical
   - Status: Open
2. Ensure cve-test-repo exists at `/Users/vaishnavimodi/Workspace/cve-test-repo`
3. Run `/cve-fixer.process`
4. Provide component name and repository path
5. Select option to fix the CVE
6. Verify PR is created with proper description
